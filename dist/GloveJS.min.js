/*! GloveJS 08-03-2015 */
function sendData(){var a,b,c,d,e,f,g,h,i;a=(buffer.readInt16LE(2)+ACC_X_OFFSET)*G_FACTOR,b=(buffer.readInt16LE(4)+ACC_Y_OFFSET)*G_FACTOR,c=(buffer.readInt16LE(6)+ACC_Z_OFFSET)*G_FACTOR,d=buffer.readInt16LE(8)/GYRO_FACTOR-GYR_X_OFFSET,e=buffer.readInt16LE(10)/GYRO_FACTOR-GYR_Y_OFFSET,f=buffer.readInt16LE(12)/GYRO_FACTOR-GYR_Z_OFFSET,g=COM_X_SCALE*(buffer.readInt16LE(14)-COM_X_OFFSET),h=COM_Y_SCALE*(buffer.readInt16LE(16)-COM_Y_OFFSET),i=COM_Z_SCALE*(buffer.readInt16LE(18)-COM_Z_OFFSET),q.update(a,b,c,degreesToRadians(d),degreesToRadians(e),degreesToRadians(f)),q.computeEuler();var j=ALPHA*f+BETA*i,k=Math.atan(b/Math.sqrt(a*a+c*c)),l=Math.atan(a/Math.sqrt(b*b+c*c));imuBuffer=[a.toFixed(2),b.toFixed(2),c.toFixed(2),d.toFixed(2),e.toFixed(2),f.toFixed(2),g.toFixed(2),h.toFixed(2),i.toFixed(2)],sampleCounter++,hand_data.push(imuBuffer),io.sockets.emit("data",{roll:k,pitch:l,yaw:j,counter:sampleCounter,raw:imuBuffer}),60==sampleCounter&&(sampleCounter=0),buffer=new Buffer(21),byteCounter=0,sp.write(READ_CMD)}function degreesToRadians(a){return a*(Math.PI/180)}function onStop(){isTracking=!1;var a=JSON.stringify(hand_data),b=new Date,c=b.getTime();fs.writeFile("g"+c+".data",a,function(a){if(a)throw a;console.log("It's saved!")}),recognizer.load(a),recognizer.cluster()}var express=require("express"),socket=require("socket.io"),chalk=require("chalk"),fs=require("fs"),wit=require("node-wit"),app=express(),port=8e3,READ_CMD=[1,2,0,128,0,0,0,0,0,0,0,0,0,0,0,3],BAUD_RATE=115200,G_FACTOR=.00390625,GYRO_FACTOR=14.375,ACC_X_OFFSET=0,ACC_Y_OFFSET=0,ACC_Z_OFFSET=38.46,GYR_X_OFFSET=.626,GYR_Y_OFFSET=-1.895,GYR_Z_OFFSET=0,COM_X_OFFSET=38,COM_Y_OFFSET=27.5,COM_Z_OFFSET=-25,COM_X_SCALE=.97,COM_Y_SCALE=.97,COM_Z_SCALE=1.05,ALPHA=.1,BETA=.9,buffer=new Buffer(21),byteCounter=0,isTracking=!1,hand_data=[],imuBuffer={},data_string="",sampleCounter=0,io=require("socket.io").listen(app.listen(port)),quaternion=require("./lib/Quaternion.js"),Recognizer=require("./lib/GestureRecognizer.js"),q=new quaternion(.1,10),recognizer=new Recognizer;console.log("listening port "+port),app.use(express["static"](__dirname+"/public"));var serialport=require("serialport").SerialPort,sp=new serialport("/dev/cu.AmpedUp-AMP-SPP",{baudrate:BAUD_RATE});sp.on("open",function(){console.log("Serial port is open"),sp.write(READ_CMD)}),sp.on("data",function(a){for(var b=0;b<a.length;++b)buffer[byteCounter]=a[b],byteCounter++;21==byteCounter&&sendData()}),sp.on("error",function(a){console.log(chalk.red(a))});var get_intent;app.get("/",function(a,b){b.sendfile(__dirname+"/public/index.html"),wit.captureTextIntent("ONGDMADEHQ5VBMYHHKWWBZQDYWQ3N3UB","move ahead",function(a,b){a&&console.log("Error: ",a),get_intent=JSON.stringify(b,null," "),io.sockets.emit("hand",{intent:get_intent})})}),io.sockets.on("connection",function(a){a.on("start",function(){hand_data=[],data_string="",isTracking=!0}),a.on("stop",onStop)});