/*! GloveJS 05-03-2015 */
function sendData(){var a,b,c,d,e,f,g,h,i;isTracking?(a=buffer.readInt16LE(2),b=buffer.readInt16LE(4),c=buffer.readInt16LE(6),d=buffer.readInt16LE(8)/GYRO_FACTOR,e=buffer.readInt16LE(10)/GYRO_FACTOR,f=buffer.readInt16LE(12)/GYRO_FACTOR,g=buffer.readInt16LE(14),h=buffer.readInt16LE(16),i=buffer.readInt16LE(18)):(a=buffer.readInt16LE(2),b=buffer.readInt16LE(4),c=buffer.readInt16LE(6),d=buffer.readInt16LE(8)/GYRO_FACTOR,e=buffer.readInt16LE(10)/GYRO_FACTOR,f=buffer.readInt16LE(12)/GYRO_FACTOR,g=buffer.readInt16LE(14),h=buffer.readInt16LE(16),i=buffer.readInt16LE(18),isTracking=!0),console.log(chalk.green("acc x is: "+(a+ACC_X_OFFSET)*G_FACTOR)),q.update(a+ACC_X_OFFSET,b+ACC_Y_OFFSET,c+ACC_Z_OFFSET,degreesToRadians(d),degreesToRadians(e),degreesToRadians(f)),q.computeEuler();var j=q.getRoll(),k=q.getPitch(),l=q.getYaw();past_buffer={acc_x:a,acc_y:b,acc_z:c,gyr_x:d,gyr_y:e,gyr_z:f,com_x:g,com_y:h,com_z:i},sampleCounter++,hand_data.push({roll:j,pitch:k,yaw:l}),io.sockets.emit("data",{roll:j,pitch:k,yaw:l,counter:sampleCounter}),60==sampleCounter&&(sampleCounter=0),buffer=new Buffer(21),byteCounter=0,sp.write(READ_CMD)}function degreesToRadians(a){return a*(Math.PI/180)}function onStop(){isTracking=!1,hand_data.forEach(function(a){data_string+=a.roll+","+a.pitch+"\n"});var a=new Date,b=a.getTime();fs.writeFile("g"+b+".csv",data_string,function(a){if(a)throw a;console.log("It's saved!")})}var express=require("express"),socket=require("socket.io"),chalk=require("chalk"),fs=require("fs"),wit=require("node-wit"),app=express(),port=8e3,READ_CMD=[1,2,0,128,0,0,0,0,0,0,0,0,0,0,0,3],BAUD_RATE=115200,G_FACTOR=.00390625,GYRO_FACTOR=14.375,ACC_X_OFFSET=0,ACC_Y_OFFSET=0,ACC_Z_OFFSET=38.46,ALPHA=.99,BETA=.01,buffer=new Buffer(21),byteCounter=0,isTracking=!1,hand_data=[],past_buffer={},data_string="",sampleCounter=0,io=require("socket.io").listen(app.listen(port)),quaternion=require("./lib/Quaternion.js"),q=new quaternion(.1,10);console.log("listening port "+port),app.use(express["static"](__dirname+"/public"));var serialport=require("serialport").SerialPort,sp=new serialport("/dev/cu.AmpedUp-AMP-SPP",{baudrate:BAUD_RATE});sp.on("open",function(){console.log("Serial port is open"),sp.write(READ_CMD)}),sp.on("data",function(a){for(var b=0;b<a.length;++b)buffer[byteCounter]=a[b],byteCounter++;21==byteCounter&&sendData()}),sp.on("error",function(a){console.log(chalk.red(a))});var get_intent;app.get("/",function(a,b){b.sendfile(__dirname+"/public/index.html"),wit.captureTextIntent("ONGDMADEHQ5VBMYHHKWWBZQDYWQ3N3UB","move ahead",function(a,b){a&&console.log("Error: ",a),get_intent=JSON.stringify(b,null," "),io.sockets.emit("hand",{intent:get_intent})})}),io.sockets.on("connection",function(a){a.on("start",function(){hand_data=[],data_string="",isTracking=!0}),a.on("stop",onStop)});